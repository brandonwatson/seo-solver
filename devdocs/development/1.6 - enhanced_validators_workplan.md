# Workplan 1.6: Enhanced Validators

## Overview

**Problem:** Our current validators detect if structured data *exists* but don't validate that required fields are present for each schema type. Google Search Console emails specifically call out missing fields like `uploadDate` and `thumbnailUrl` on VideoObject schemas.

**Solution:** Enhance validators to:
- Validate required/recommended fields per schema.org type
- Detect HTTP errors (404, 5xx)
- Validate field value formats (ISO dates, URLs, etc.)
- Catch issues proactively before Google does

**Why This Matters:**
- GSC integration (Workplan 1.5) is the primary source when connected
- These validators are the fallback for sites without GSC
- Proactive detection catches issues before they become GSC alerts
- Reference implementation for community-contributed validators

**Relationship to Other Workplans:**
- Workplan 1: Foundation ✅ (basic validators exist)
- Workplan 1.5: GSC Integration (primary data source)
- **Workplan 1.6: This one** (enhanced secondary validators)

---

## Implementation Strategy

**Approach:** Enhance existing validators with schema-specific validation rules based on the knowledge base in `docs/issue-knowledge-base.md`.

**Key Decisions:**
- Use schema.org type definitions as source of truth
- Required vs recommended fields map to error vs warning severity
- Field format validation uses standard patterns (ISO 8601, URLs)
- Keep validators as pure functions for testability

---

## Phase 1: Schema-Specific Field Validation

- **STATUS:** PENDING
- **Goal:** Validate required and recommended fields for each schema.org type
- **Estimated Effort:** Medium (2-3 sessions)

### Schema Types to Support

Based on `docs/issue-knowledge-base.md` and common GSC issues:

| Schema Type | Required Fields | Recommended Fields |
|-------------|-----------------|-------------------|
| VideoObject | `name`, `thumbnailUrl`, `uploadDate` | `description`, `duration`, `contentUrl`, `embedUrl` |
| Product | `name`, `image`, `offers.price`, `offers.priceCurrency` | `description`, `brand`, `sku`, `review`, `aggregateRating` |
| Article | `headline`, `image`, `datePublished`, `author` | `description`, `dateModified`, `publisher` |
| FAQPage | `mainEntity[]` with Question/Answer | |
| BreadcrumbList | `itemListElement[]` with `item`, `name`, `position` | |
| Organization | `name`, `url` | `logo`, `contactPoint`, `sameAs` |
| LocalBusiness | `name`, `address`, `telephone` | `openingHours`, `geo`, `priceRange` |
| Recipe | `name`, `image`, `author` | `datePublished`, `description`, `prepTime`, `cookTime`, `recipeIngredient`, `recipeInstructions` |
| Event | `name`, `startDate`, `location` | `endDate`, `description`, `image`, `performer`, `offers` |
| Review | `itemReviewed`, `author`, `reviewRating` | `datePublished`, `reviewBody` |

### Tasks

- **1.1. Create Schema Definitions:**
    - File: `src/validators/schema-definitions.ts`
    - Define required/recommended fields per type
    - Include nested object requirements (e.g., `offers.price`)
    - Export as typed constants

- **1.2. Enhance Structured Data Validator:**
    - File: `src/validators/structured-data.ts`
    - Parse JSON-LD and identify `@type`
    - Look up field requirements for that type
    - Check for missing required fields → error
    - Check for missing recommended fields → warning
    - Include field path in issue details

- **1.3. Handle Nested Types:**
    - VideoObject inside Article
    - Offers inside Product
    - Question/Answer inside FAQPage
    - Validate nested objects recursively

- **1.4. Handle Multiple Schemas:**
    - Pages can have multiple JSON-LD blocks
    - Validate each independently
    - Detect duplicate schemas of same type

- **1.5. Add Tests:**
    - Test fixtures for each schema type
    - Valid examples with all fields
    - Invalid examples with missing required fields
    - Edge cases (empty arrays, null values)

- **1.6. Verify:**
    - Run against calminterview.com
    - Confirm VideoObject missing `uploadDate`/`thumbnailUrl` is detected
    - Compare with actual GSC issues

---

## Phase 2: Field Value Validation

- **STATUS:** PENDING
- **Goal:** Validate that field values match expected formats
- **Estimated Effort:** Small (1-2 sessions)

### Field Format Rules

| Field Pattern | Expected Format | Example |
|---------------|-----------------|---------|
| `*Date`, `datePublished`, `uploadDate` | ISO 8601 | `2025-01-04T00:00:00Z` |
| `duration` | ISO 8601 duration | `PT15M30S` |
| `url`, `*Url`, `image` | Absolute URL | `https://example.com/image.jpg` |
| `price` | Number as string | `"29.99"` |
| `email` | Email format | `user@example.com` |
| `telephone` | E.164 or common format | `+1-555-123-4567` |

### Tasks

- **2.1. Create Format Validators:**
    - File: `src/validators/format-validators.ts`
    - `isValidISODate(value: string): boolean`
    - `isValidISODuration(value: string): boolean`
    - `isAbsoluteUrl(value: string): boolean`
    - `isValidPrice(value: unknown): boolean`

- **2.2. Integrate with Structured Data Validator:**
    - After checking field presence, validate format
    - Return `invalid_field_value` with details
    - Include expected format in suggested fix

- **2.3. Common Mistakes Detection:**
    - Human-readable dates ("January 4, 2025") → suggest ISO format
    - Relative URLs ("/image.jpg") → suggest absolute URL
    - Plain numbers (29.99) → suggest string format for price

- **2.4. Add Tests:**
    - Valid and invalid examples for each format
    - Edge cases (timezones, currency symbols)

---

## Phase 3: HTTP Status Detection

- **STATUS:** PENDING
- **Goal:** Detect 404 and 5xx errors
- **Estimated Effort:** Small (1 session)

### Tasks

- **3.1. Enhance Indexing Validator:**
    - File: `src/validators/indexing.ts`
    - Already fetching pages - check status codes
    - 404 → `not_found_404` error
    - 5xx → `server_error_5xx` error
    - Include status code in details

- **3.2. Handle Soft 404s:**
    - Page returns 200 but has "not found" content
    - Check for common patterns ("page not found", "404", "does not exist")
    - Flag as warning with suggestion to return proper 404

- **3.3. Add Tests:**
    - Mock server returning various status codes
    - Test redirect → 404 scenarios

---

## Phase 4: Additional Issue Types

- **STATUS:** PENDING
- **Goal:** Implement remaining issue types from schema
- **Estimated Effort:** Small (1-2 sessions)

### Missing Issue Types

| Type | Detection Method |
|------|------------------|
| `invalid_field_type` | Check field value type matches schema expectation |
| `duplicate_schema` | Multiple JSON-LD blocks with same `@type` and `@id` |

### Tasks

- **4.1. Implement invalid_field_type:**
    - Array when expecting string
    - Object when expecting string
    - String when expecting array
    - Include expected vs actual type in details

- **4.2. Implement duplicate_schema:**
    - Track `@type` + `@id` combinations
    - Flag duplicates with warning
    - Suggest consolidating or differentiating

- **4.3. Update OpenAPI Spec:**
    - Ensure all new issue types are documented
    - Add example responses

---

## Phase 5: Validator Test Suite

- **STATUS:** PENDING
- **Goal:** Comprehensive tests using shared fixtures
- **Estimated Effort:** Medium (2-3 sessions)

### Tasks

- **5.1. Create Test HTML Fixtures:**
    - Files: `shared/test-fixtures/html/schema-*.html`
    - One file per schema type with valid/invalid examples
    - Include all edge cases

- **5.2. Unit Tests for Validators:**
    - Files: `implementations/aws-typescript/tests/validators/*.test.ts`
    - Test each validator function
    - Mock HTTP responses
    - Test all issue types

- **5.3. Integration Tests:**
    - Test full validation flow
    - Verify issue aggregation
    - Test with real sites (example.com, etc.)

- **5.4. CI Integration:**
    - Add test command to package.json
    - Create GitHub Actions workflow
    - Run on PR

---

## Expected Results

After completing this workplan:
- VideoObject validation catches missing `uploadDate`, `thumbnailUrl`
- Product validation catches missing `offers.price`
- Article validation catches missing `author`, `datePublished`
- Field format validation catches human-readable dates
- HTTP 404/5xx errors are detected
- All 28 issue types from schema are implemented
- Comprehensive test coverage

---

## Validator Coverage Matrix

After completion:

| Category | Issue Type | Phase | Status |
|----------|------------|-------|--------|
| structured_data | missing_required_field | 1 | ⚠️ Enhance |
| structured_data | missing_recommended_field | 1 | ⚠️ Enhance |
| structured_data | invalid_field_value | 2 | ⚠️ Enhance |
| structured_data | invalid_field_type | 4 | ❌ Add |
| structured_data | missing_schema | - | ✅ Done |
| structured_data | syntax_error | - | ✅ Done |
| structured_data | duplicate_schema | 4 | ❌ Add |
| indexing | duplicate_without_canonical | - | ✅ Done |
| indexing | conflicting_canonical | - | ✅ Done |
| indexing | crawled_not_indexed | - | ⏸️ GSC only |
| indexing | discovered_not_indexed | - | ⏸️ GSC only |
| indexing | blocked_by_robots | - | ✅ Done |
| indexing | noindex_tag | - | ✅ Done |
| indexing | not_found_404 | 3 | ❌ Add |
| indexing | server_error_5xx | 3 | ❌ Add |
| indexing | redirect_chain | - | ✅ Done |
| indexing | redirect_loop | - | ✅ Done |
| performance | poor_lcp | - | ✅ Done |
| performance | needs_improvement_lcp | - | ✅ Done |
| performance | poor_inp | - | ✅ Done |
| performance | needs_improvement_inp | - | ✅ Done |
| performance | poor_cls | - | ✅ Done |
| performance | needs_improvement_cls | - | ✅ Done |
| mobile | no_viewport | - | ✅ Done |
| mobile | text_too_small | - | ✅ Done |
| mobile | tap_targets_too_close | - | ✅ Done |
| mobile | content_wider_than_screen | - | ✅ Done |

---

## TRACKING SUMMARY

_To be filled in after completion of work in a phase_

### Phase 1 Completed Features

- TBD

### Phase 2 Completed Features

- TBD

### Phase 3 Completed Features

- TBD

### Phase 4 Completed Features

- TBD

### Phase 5 Completed Features

- TBD

### Technical Notes and Learnings

- TBD
